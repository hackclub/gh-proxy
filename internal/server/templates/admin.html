<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>gh-proxy admin</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; margin: 1rem; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem }
    .card { border: 1px solid #eee; border-radius: 8px; padding: 1rem }
    .muted { color: #666 }
  </style>
</head>
<body>
  <h1>Admin</h1>
  <div class="grid">
    <div class="card"><div>Total requests</div><h2 id="totalRequests">{{.totalRequests}}</h2></div>
    <div class="card"><div>Cache hit rate</div><h2 id="cacheHitRate">{{.cacheHitRate}}</h2></div>
    <div class="card"><div>Today's requests</div><h2 id="today">{{.today}}</h2></div>
    <div class="card"><div>Active donated tokens</div><h2 id="activeTokens">{{.activeTokens}}</h2></div>
  </div>

  <h2>API Keys</h2>
  <form method="post" action="/admin/apikeys">
    <input name="hc_username" placeholder="Hack Club username" required />
    <input name="app_name" placeholder="App name" required />
    <input name="machine" placeholder="Machine" required />
    <input name="rate_limit" type="number" placeholder="Rate limit per second (default 10)" />
    <button type="submit">Create</button>
  </form>

  <table>
    <thead><tr><th>Key</th><th>Total requests</th><th>Cache hit rate</th><th>Last used</th><th>Daily (7d)</th><th>Actions</th></tr></thead>
    <tbody id="apikeys"></tbody>
  </table>

  <h2>Recent Activity</h2>
  <ul id="recent" class="muted"></ul>

<script>
const ws = new WebSocket((location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/admin/ws');
ws.onmessage = (ev) => {
  const msg = JSON.parse(ev.data);
  if (msg.type==='stats') {
    const s = msg.data;
    document.getElementById('totalRequests').textContent = s.totalRequests;
    document.getElementById('cacheHitRate').textContent = s.cacheHitRate;
    document.getElementById('today').textContent = s.today;
    document.getElementById('activeTokens').textContent = s.activeTokens;
    refreshAPIKeys();
  } else if (msg.type==='recent') {
    appendRecent(msg.data);
  }
};

function appendRecent(text) {
  const li = document.createElement('li');
  li.textContent = text;
  const ul = document.getElementById('recent');
  ul.prepend(li);
  while (ul.children.length>1000) ul.removeChild(ul.lastChild);
}

function sparkline(points) {
  // points is array of numbers length <= 7
  const max = Math.max(1, ...points);
  const w = 70, h = 18, pad = 2;
  const step = (w - pad*2) / Math.max(1, points.length-1);
  const ys = points.map(v => h - pad - (v/max)*(h - pad*2));
  let d = '';
  ys.forEach((y,i) => { const x = pad + i*step; d += (i?' L':'M')+x.toFixed(1)+','+y.toFixed(1); });
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><path d="${d}" fill="none" stroke="#111" stroke-width="1.5"/></svg>`;
}

async function refreshAPIKeys(){
  const [res, usageRes] = await Promise.all([
    fetch('/admin/keys.json'),
    fetch('/admin/keys_usage.json')
  ]);
  if(!res.ok) return;
  const data = await res.json();
  const usage = usageRes.ok ? await usageRes.json() : {};
  const tbody = document.getElementById('apikeys');
  tbody.innerHTML = '';
  for (const k of data) {
    const tr = document.createElement('tr');
    const series = (usage[k.key]||[]).map(p=>p.c);
    tr.innerHTML = `<td>${k.key}</td><td>${k.total}</td><td>${k.hit_rate.toFixed ? k.hit_rate.toFixed(1)+'%' : k.hit_rate}</td><td>${k.last_used||''}</td><td>${sparkline(series)}</td><td>${k.disabled?'disabled':`<form method='post' action='/admin/apikeys/${k.key}/disable'><button>Disable</button></form>`}</td>`;
    tbody.appendChild(tr);
  }
}

refreshAPIKeys();

// load initial 1000 recent from server (ensure most recent at top)
fetch('/admin/recent.json').then(r=>r.ok?r.json():[]).then(rows=>{
  const ul = document.getElementById('recent');
  ul.innerHTML = '';
  // rows come sorted DESC from the server; iterate from oldest->newest so prepend yields newest at top
  for (let i = rows.length - 1; i >= 0; i--) {
    const r = rows[i];
    appendRecent(`${r.method} ${r.path}`);
  }
});
</script>
</body>
</html>
