<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>gh-proxy admin</title>
  <meta name="csrf-token" content="{{.csrf}}" />
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; margin: 1rem; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem }
    .card { border: 1px solid #eee; border-radius: 8px; padding: 1rem }
    .muted { color: #666 }
    .nav-link { display: inline-block; margin-right: 1rem; padding: 0.5rem 1rem; background: #f0f0f0; color: #333; text-decoration: none; border-radius: 4px; font-size: 0.9rem; }
    .nav-link:hover { background: #e0e0e0; }
  </style>
</head>
<body>
  <div style="margin-bottom: 1rem;">
    <a href="/" class="nav-link">‚Üê Home</a>
    <a href="/docs" class="nav-link">üìö API Docs</a>
  </div>
  <h1>Admin</h1>
  <div class="grid">
    <div class="card"><div>Total requests</div><h2 id="totalRequests">{{.totalRequests}}</h2></div>
    <div class="card"><div>Cache hit rate</div><h2 id="cacheHitRate">{{.cacheHitRate}}</h2></div>
    <div class="card"><div>Today's requests</div><h2 id="today">{{.today}}</h2></div>
    <div class="card"><div>Active donated tokens</div><h2 id="activeTokens">{{.activeTokens}}</h2></div>
  </div>

  <h2>API Keys</h2>
  <form method="post" action="/admin/apikeys">
    <input name="hc_username" placeholder="Hack Club username" required />
    <input name="app_name" placeholder="App name" required />
    <input name="machine" placeholder="Machine" required />
    <input name="rate_limit" type="number" placeholder="Rate limit per second (default 10)" />
    <input type="hidden" name="csrf" value="{{.csrf}}" />
    <button type="submit">Create</button>
  </form>

  <table>
    <thead><tr><th>Key</th><th>Total requests</th><th>Cache hit rate</th><th>Last used</th><th>Daily (7d)</th><th>Actions</th></tr></thead>
    <tbody id="apikeys"></tbody>
  </table>

  <h2>Recent Activity</h2>
  <ul id="recent" class="muted"></ul>

<script>
const ws = new WebSocket((location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/admin/ws');
const CSRF = document.querySelector('meta[name="csrf-token"]').content;
ws.onmessage = (ev) => {
  const msg = JSON.parse(ev.data);
  if (msg.type==='stats') {
    const s = msg.data;
    document.getElementById('totalRequests').textContent = s.totalRequests;
    document.getElementById('cacheHitRate').textContent = s.cacheHitRate;
    document.getElementById('today').textContent = s.today;
    document.getElementById('activeTokens').textContent = s.activeTokens;
    refreshAPIKeys();
  } else if (msg.type==='recent') {
    appendRecent(msg.data);
  }
};

function ago(ts){
  const d = new Date(ts);
  const s = Math.max(1, Math.floor((Date.now()-d.getTime())/1000));
  if (s<60) return s+"s ago";
  const m = Math.floor(s/60); if (m<60) return m+"m ago";
  const h = Math.floor(m/60); if (h<24) return h+"h ago";
  const days = Math.floor(h/24); return days+"d ago";
}

function appendRecent(data) {
  const li = document.createElement('li');
  if (typeof data === 'string') {
    li.textContent = data;
  } else {
    li.textContent = `${data.display||''} ‚Äî ${data.method} ${data.path} ‚Äî ${ago(data.created_at)}`;
  }
  const ul = document.getElementById('recent');
  ul.prepend(li);
  while (ul.children.length>1000) ul.removeChild(ul.lastChild);
}

function sparkline(points) {
  const max = Math.max(1, ...points);
  const w = 70, h = 18, pad = 2;
  const step = (w - pad*2) / Math.max(1, points.length-1);
  const ys = points.map(v => h - pad - (v/max)*(h - pad*2));
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('width', w); svg.setAttribute('height', h);
  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  const path = document.createElementNS('http://www.w3.org/2000/svg','path');
  let d = '';
  ys.forEach((y,i) => { const x = pad + i*step; d += (i?' L':'M')+x.toFixed(1)+','+y.toFixed(1); });
  path.setAttribute('d', d); path.setAttribute('fill','none'); path.setAttribute('stroke','#111'); path.setAttribute('stroke-width','1.5');
  svg.appendChild(path);
  return svg;
}

async function refreshAPIKeys(){
  const [res, usageRes] = await Promise.all([
    fetch('/admin/keys.json'),
    fetch('/admin/keys_usage.json')
  ]);
  if(!res.ok) return;
  const data = await res.json();
  const usage = usageRes.ok ? await usageRes.json() : {};
  const tbody = document.getElementById('apikeys');
  tbody.innerHTML = '';
  for (const k of data) {
    const tr = document.createElement('tr');
    const tdKey = document.createElement('td'); tdKey.textContent = k.display; tr.appendChild(tdKey);
    const tdTotal = document.createElement('td'); tdTotal.textContent = String(k.total); tr.appendChild(tdTotal);
    const tdHit = document.createElement('td'); tdHit.textContent = (k.hit_rate && k.hit_rate.toFixed) ? k.hit_rate.toFixed(1)+'%' : String(k.hit_rate); tr.appendChild(tdHit);
    const tdLast = document.createElement('td'); tdLast.textContent = k.last_used || ''; tr.appendChild(tdLast);
    const tdSpark = document.createElement('td'); tdSpark.appendChild(sparkline((usage[k.id]||[]).map(p=>p.c))); tr.appendChild(tdSpark);
    const tdAct = document.createElement('td');
    if (k.disabled) { tdAct.textContent = 'disabled'; }
    else {
      const form = document.createElement('form'); form.method = 'post'; form.action = `/admin/apikeys/${k.id}/disable`;
      const hidden = document.createElement('input'); hidden.type='hidden'; hidden.name='csrf'; hidden.value=CSRF; form.appendChild(hidden);
      const btn = document.createElement('button'); btn.textContent = 'Disable'; form.appendChild(btn);
      tdAct.appendChild(form);
    }
    tr.appendChild(tdAct);
    tbody.appendChild(tr);
  }
}

refreshAPIKeys();

// load initial 1000 recent from server (ensure most recent at top)
fetch('/admin/recent.json').then(r=>r.ok?r.json():[]).then(rows=>{
  const ul = document.getElementById('recent');
  ul.innerHTML = '';
  // rows come sorted DESC from the server; iterate from oldest->newest so prepend yields newest at top
  for (let i = rows.length - 1; i >= 0; i--) {
    const r = rows[i];
    appendRecent(r);
  }
});
</script>
</body>
</html>
